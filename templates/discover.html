{% extends 'base.html' %}

{% block title %}–ê–≤—Ç–æ–ø–æ—à—É–∫ –∞–∫–∞—É–Ω—Ç—ñ–≤{% endblock %}

{% block content %}
<div class="discover-page">
    <div class="page-header">
        <h1>üîç –ê–≤—Ç–æ–ø–æ—à—É–∫ —Å—Ö–æ–∂–∏—Ö –∞–∫–∞—É–Ω—Ç—ñ–≤</h1>
        <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–æ—à—É–∫ —Å—Ç–æ—Ä—ñ–Ω–æ–∫ —Ä–µ–º–æ–Ω—Ç—É/–∫–∞—Ñ–µ–ª—é –≤ —Ä–µ–≥—ñ–æ–Ω—ñ –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç–∞</p>
    </div>
    
    <div class="disclaimer-box" style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <p style="margin: 0; color: #856404;">‚ö†Ô∏è <strong>–í–∞–∂–ª–∏–≤–æ:</strong> –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∞—Ü—é—î –ª–∏—à–µ –∑ –ø—É–±–ª—ñ—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∏–º–∏ –¥–∞–Ω–∏–º–∏. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É —Ä–∏–Ω–∫—É.</p>
    </div>
    
    <div class="two-columns">
        <!-- –§–æ—Ä–º–∞ –ø–æ—à—É–∫—É -->
        <div class="card">
            <h3>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∞–≤—Ç–æ–ø–æ—à—É–∫</h3>
            <p class="text-muted">–°–∏—Å—Ç–µ–º–∞ –∑–Ω–∞–π–¥–µ –∞–∫–∞—É–Ω—Ç–∏ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑ —Ä–µ–º–æ–Ω—Ç–æ–º —Ç–∞ –∫–∞—Ñ–µ–ª–µ–º –±—ñ–ª—è –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç–∞</p>
            
            <form method="POST" action="{{ url_for('discover_accounts') }}">
                <div class="form-group">
                    <label for="instagram_account_id">–û–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –¥–ª—è –ø–æ—à—É–∫—É:</label>
                    <select id="instagram_account_id" name="instagram_account_id" required>
                        <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç --</option>
                        {% for account in accounts %}
                            <option value="{{ account.id }}">
                                @{{ account.instagram_username }}
                            </option>
                        {% endfor %}
                    </select>
                    {% if not accounts %}
                        <div class="warning-box" style="margin-top: 10px;">
                            <p>‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ Instagram –∞–∫–∞—É–Ω—Ç</p>
                            <a href="{{ url_for('manage_accounts') }}" class="btn btn-small btn-secondary">–î–æ–¥–∞—Ç–∏ –∞–∫–∞—É–Ω—Ç</a>
                        </div>
                    {% endif %}
                </div>
                
                <div class="info-box">
                    <h4>üéØ –©–æ —à—É–∫–∞—î–º–æ:</h4>
                    <ul>
                        <li><strong>–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞:</strong> fliesen, fliesenleger, badsanierung, renovierung</li>
                        <li><strong>–†–µ–≥—ñ–æ–Ω:</strong> Frankfurt, Offenbach, Darmstadt, Mainz, Wiesbaden (+100 –∫–º)</li>
                        <li><strong>–¢–∏–ø:</strong> –ë—ñ–∑–Ω–µ—Å-–∞–∫–∞—É–Ω—Ç–∏, –º–∞–π—Å—Ç—Ä–∏, –∫–æ–º–ø–∞–Ω—ñ—ó</li>
                    </ul>
                </div>
                
                <button type="submit" class="btn btn-primary btn-large btn-block" {% if not accounts %}disabled{% endif %}>
                    üîç –ó–Ω–∞–π—Ç–∏ —Å—Ö–æ–∂—ñ –∞–∫–∞—É–Ω—Ç–∏
                </button>
            </form>
        </div>
        
        <!-- –•–µ—à—Ç–µ–≥–∏ –¥–ª—è –ø–æ—à—É–∫—É -->
        <div class="card">
            <h3>üìå –•–µ—à—Ç–µ–≥–∏ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</h3>
            <p class="text-muted">–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª—ñ–∑—É—î —Ü—ñ —Ö–µ—à—Ç–µ–≥–∏:</p>
            
            <div class="tags-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
                {% for tag in hashtags %}
                    <span class="tag-badge" style="background: #e1e8ed; padding: 5px 12px; border-radius: 15px; font-size: 14px;">
                        #{{ tag }}
                    </span>
                {% endfor %}
            </div>
            
            <div style="margin-top: 20px;">
                <h4>üèôÔ∏è –ú—ñ—Å—Ç–∞ –≤ —Ä–∞–¥—ñ—É—Å—ñ 100 –∫–º:</h4>
                <p style="color: #666; font-size: 14px;">
                    Frankfurt, Offenbach, Darmstadt, Mainz, Wiesbaden, Hanau, Aschaffenburg, 
                    Bad Homburg, R√ºsselsheim, Bensheim, Heidelberg, Mannheim, Worms...
                </p>
            </div>
        </div>
    </div>
    
    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ—à—É–∫—É -->
    {% if discovered %}
    <div class="card" style="margin-top: 30px;">
        <h2>‚úÖ –ó–Ω–∞–π–¥–µ–Ω—ñ –∞–∫–∞—É–Ω—Ç–∏ ({{ discovered|length }})</h2>
        <p class="text-muted">–°–æ—Ä—Ç–æ–≤–∞–Ω–æ –∑–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ñ—Å—Ç—é. –í—ñ–¥–º—ñ—Ç—å—Ç–µ –∞–∫–∞—É–Ω—Ç–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥—É –ø—ñ–¥–ø–∏—Å–Ω–∏–∫—ñ–≤.</p>
        
        <form method="POST" action="{{ url_for('parse_competitors') }}">
            <input type="hidden" name="instagram_account_id" value="{{ selected_instagram_account_id or (accounts[0].id if accounts else '') }}">
            
            <div class="table-responsive">
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onclick="toggleAll(this)"></th>
                            <th>–ü—Ä–æ—Ñ—ñ–ª—å</th>
                            <th>–ú—ñ—Å—Ç–æ</th>
                            <th>–ö–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞</th>
                            <th>Score</th>
                            <th>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for acc in discovered %}
                        <tr>
                            <td>
                                <input type="checkbox" name="selected_accounts" value="{{ acc.username }}" 
                                    {% if acc.relevance_score >= 40 %}checked{% endif %}>
                            </td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    {% if acc.profile_pic_url %}
                                        <img src="{{ acc.profile_pic_url }}" alt="" style="width: 40px; height: 40px; border-radius: 50%;">
                                    {% endif %}
                                    <div>
                                        <strong>@{{ acc.username }}</strong>
                                        {% if acc.is_verified %}‚úì{% endif %}
                                        {% if acc.is_business %}üíº{% endif %}
                                        <br>
                                        <small style="color: #666;">{{ acc.full_name }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if acc.is_frankfurt_region %}
                                    <span style="color: green;">üìç {{ acc.detected_city or 'Frankfurt Region' }}</span>
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if acc.matched_keywords %}
                                    {% for kw in acc.matched_keywords[:3] %}
                                        <span class="keyword-tag" style="background: #e3f2fd; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-right: 4px;">{{ kw }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span style="color: #999;">‚Äî</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="score-bar" style="width: 60px; background: #eee; border-radius: 3px; height: 8px;">
                                    <div style="width: {{ acc.relevance_score }}%; background: {% if acc.relevance_score >= 60 %}#28a745{% elif acc.relevance_score >= 40 %}#ffc107{% else %}#dc3545{% endif %}; height: 100%; border-radius: 3px;"></div>
                                </div>
                                <small>{{ acc.relevance_score }}/100</small>
                            </td>
                            <td>
                                <span style="font-size: 13px;">{{ acc.recommendation }}</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div style="margin-top: 20px; display: flex; gap: 15px;">
                <button type="submit" class="btn btn-primary">
                    üì• –ó—ñ–±—Ä–∞—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä—ñ—é –∑ –æ–±—Ä–∞–Ω–∏—Ö –∞–∫–∞—É–Ω—Ç—ñ–≤
                </button>
                <button type="button" class="btn btn-secondary" onclick="copyUsernames()">
                    üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ username'–∏
                </button>
            </div>
        </form>
    </div>
    {% endif %}
</div>

<script>
// Preselect the account used for the last discover run (if available)
(function () {
    const selectedId = {{ (selected_instagram_account_id or '')|tojson }};
    if (!selectedId) return;
    const sel = document.getElementById('instagram_account_id');
    if (!sel) return;
    sel.value = selectedId;
})();
</script>

<script>
function toggleAll(source) {
    const checkboxes = document.querySelectorAll('input[name="selected_accounts"]');
    checkboxes.forEach(cb => cb.checked = source.checked);
}

function copyUsernames() {
    const checked = document.querySelectorAll('input[name="selected_accounts"]:checked');
    const usernames = Array.from(checked).map(cb => cb.value).join(', ');
    navigator.clipboard.writeText(usernames).then(() => {
        alert('–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: ' + usernames);
    });
}
</script>

<style>
.discover-page .two-columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
@media (max-width: 768px) {
    .discover-page .two-columns {
        grid-template-columns: 1fr;
    }
}
.table-responsive {
    overflow-x: auto;
}
.table {
    width: 100%;
    border-collapse: collapse;
}
.table th, .table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}
.table th {
    background: #f8f9fa;
    font-weight: 600;
}
.table tr:hover {
    background: #f8f9fa;
}
</style>
{% endblock %}
