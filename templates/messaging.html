{% extends "base.html" %}

{% block title %}üì® –†–æ–∑—Å–∏–ª–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å{% endblock %}

{% block content %}
<div class="container">
    <h1>üì® –†–æ–∑—Å–∏–ª–∫–∞ –≤ Direct</h1>

    <!-- DM Assistant settings -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2>ü§ñ –ê–≤—Ç–æ-–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á –≤ Direct (OpenAI)</h2>
        <p style="color:#666; margin-top: 6px;">
            –ê—Å–∏—Å—Ç–µ–Ω—Ç –ø–µ—Ä—ñ–æ–¥–∏—á–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –≤—Ö—ñ–¥–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–∞ –≤–∞—à–∏–º–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è–º–∏.
            –î–ª—è —Ä–æ–±–æ—Ç–∏ –ø–æ—Ç—Ä—ñ–±–µ–Ω –æ–∫—Ä–µ–º–∏–π –≤–æ—Ä–∫–µ—Ä.
        </p>

        <form id="dmAssistantForm" method="POST" action="{{ url_for('dm_assistant_save_settings') }}" style="display:grid; gap: 12px;">
            <div class="form-group">
                <label><strong>üì± –ê–∫–∞—É–Ω—Ç:</strong></label>
                <select id="dmAccountSelect" name="account_id" class="form-control" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç --</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">@{{ account.instagram_username }}</option>
                    {% endfor %}
                </select>
                <small style="color:#666;">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –æ–∫—Ä–µ–º–æ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∞–∫–∞—É–Ω—Ç–∞.</small>
            </div>

            <label style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" name="enabled">
                <span><strong>–£–≤—ñ–º–∫–Ω—É—Ç–∏</strong> –∞–≤—Ç–æ-–≤—ñ–¥–ø–æ–≤—ñ–¥–∞—á</span>
            </label>

            <label style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" name="reply_to_existing_threads">
                <span>–í—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ –≤ —ñ—Å–Ω—É—é—á–∏—Ö –¥—ñ–∞–ª–æ–≥–∞—Ö (–Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ –Ω–∞ –ø–µ—Ä—à–æ–º—É –∑–∞–ø—É—Å–∫—É)</span>
            </label>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div>
                    <label><strong>–ú–æ–≤–∞:</strong></label><br>
                    <select name="language" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 160px;">
                        <option value="ru">ru</option>
                        <option value="uk">uk</option>
                        <option value="de">de</option>
                        <option value="en">en</option>
                    </select>
                </div>
                <div>
                    <label><strong>–õ—ñ–º—ñ—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π/–¥–µ–Ω—å:</strong></label><br>
                    <input type="number" name="max_replies_per_day" min="1" max="200" value="20"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 160px;">
                </div>
            </div>

            <div class="form-group">
                <label><strong>üßæ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –∞—Å–∏—Å—Ç–µ–Ω—Ç–∞ (system prompt):</strong></label>
                <textarea name="system_instructions" rows="6"
                          style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                          placeholder="–ù–∞–ø—Ä.: –¢–∏ –∞—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω—ñ—ó –∑ —Ä–µ–º–æ–Ω—Ç—É –≤–∞–Ω–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç —É –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç—ñ. –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π –≤–≤—ñ—á–ª–∏–≤–æ, –∫–æ—Ä–æ—Ç–∫–æ, —Å—Ç–∞–≤ 1-2 —É—Ç–æ—á–Ω—é—é—á–∏—Ö –ø–∏—Ç–∞–Ω–Ω—è (—Ä–∞–π–æ–Ω, —Ç–∏–ø –æ–±'—î–∫—Ç–∞, —Å—Ç—Ä–æ–∫–∏), –ø—Ä–æ–ø–æ–Ω—É–π –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é. –ù–µ –æ–±—ñ—Ü—è–π —Ç–æ—á–Ω—É —Ü—ñ–Ω—É –±–µ–∑ –∑–∞–º—ñ—Ä—É."></textarea>
                <small style="color:#666;">–ü–æ—Ä–∞–¥–∞: –¥–æ–¥–∞–π—Ç–µ —Å—Ü–µ–Ω–∞—Ä—ñ–π (–≤—ñ—Ç–∞–Ω–Ω—è ‚Üí –ø–∏—Ç–∞–Ω–Ω—è ‚Üí CTA).</small>
            </div>

            <button type="submit" class="btn-primary"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; width: fit-content;">
                üíæ –ó–±–µ—Ä–µ–≥—Ç–∏
            </button>

            <div style="color:#666; font-size: 0.9em;">
                –í–æ—Ä–∫–µ—Ä: <code>py -3.10 dm_assistant_runner.py</code> (–ø–æ—Ç—Ä—ñ–±–Ω–æ <code>ENABLE_DM_ASSISTANT=true</code> –≤ .env)
                <br>
                –û–¥–∏–Ω –∑–∞–ø—É—Å–∫ –≤—Å—ñ—Ö –≤–æ—Ä–∫–µ—Ä—ñ–≤: <code>py -3.10 all_workers_runner.py</code> (–ø–æ—Ç—Ä—ñ–±–Ω–æ <code>ENABLE_ALL_WORKERS=true</code>)
            </div>
        </form>
    </div>

    <!-- Invite campaign automation -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <h2>üì£ –ê–≤—Ç–æ-—Ä–æ–∑—Å–∏–ª–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω—å (–ø—Ä–æ–≥—Ä–∞–º–∞)</h2>
        <p style="color:#666; margin-top: 6px;">
            –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ –∫—Ä–æ–∫–∞—Ö (follow-up), –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ω–∞ –ø–æ–≤—Ç–æ—Ä–∏ —ñ –∑—É–ø–∏–Ω—è—î—Ç—å—Å—è, —è–∫—â–æ –ª—é–¥–∏–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–ª–∞.
        </p>

        <form id="inviteCampaignForm" method="POST" action="{{ url_for('invite_campaign_save_settings') }}" style="display:grid; gap: 12px;">
            <div class="form-group">
                <label><strong>üì± –ê–∫–∞—É–Ω—Ç:</strong></label>
                <select id="inviteAccountSelect" name="account_id" class="form-control" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç --</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">@{{ account.instagram_username }}</option>
                    {% endfor %}
                </select>
            </div>

            <label style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" name="enabled">
                <span><strong>–£–≤—ñ–º–∫–Ω—É—Ç–∏</strong> –∞–≤—Ç–æ-—Ä–æ–∑—Å–∏–ª–∫—É</span>
            </label>

            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                <div>
                    <label><strong>–ê—É–¥–∏—Ç–æ—Ä—ñ—è:</strong></label><br>
                    <select name="audience_type" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 220px;">
                        <option value="target">üéØ –¶—ñ–ª—å–æ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è</option>
                        <option value="frankfurt">üìç –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç —Ä–µ–≥—ñ–æ–Ω</option>
                        <option value="all">üìã –í—Å—ñ</option>
                    </select>
                </div>
                <div>
                    <label><strong>–õ—ñ–º—ñ—Ç/–¥–µ–Ω—å:</strong></label><br>
                    <input type="number" name="max_sends_per_day" min="1" max="200" value="20"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 140px;">
                </div>
                <div>
                    <label><strong>Delay (—Å–µ–∫):</strong></label><br>
                    <input type="number" name="min_delay_seconds" min="10" max="600" value="45"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 110px;"> -
                    <input type="number" name="max_delay_seconds" min="10" max="600" value="75"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 110px;">
                </div>
            </div>

            <label style="display:flex; gap:10px; align-items:center;">
                <input type="checkbox" name="stop_on_inbound_reply" checked>
                <span>–ó—É–ø–∏–Ω—è—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É, —è–∫—â–æ –ª—é–¥–∏–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–ª–∞</span>
            </label>

            <div class="form-group">
                <label><strong>–ö—Ä–æ–∫ 1 (–≤—ñ–¥—Ä–∞–∑—É):</strong></label>
                <textarea name="step1" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                          placeholder="–ü—Ä–∏–≤—ñ—Ç, {name}! –ú–∏ –∑–∞–π–º–∞—î–º–æ—Å—å —Ä–µ–º–æ–Ω—Ç–æ–º –≤–∞–Ω–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç —É –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç—ñ. –ü—ñ–¥–ø–∏—à—ñ—Ç—å—Å—è, –±—É–¥—å –ª–∞—Å–∫–∞ ‚Äî —É –Ω–∞—Å –±–∞–≥–∞—Ç–æ –ø—Ä–∏–∫–ª–∞–¥—ñ–≤ —Ä–æ–±—ñ—Ç."></textarea>
                <small style="color:#666;">–ó–º—ñ–Ω–Ω—ñ: {name}, {username}</small>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div style="flex: 1; min-width: 240px;">
                    <label><strong>–ö—Ä–æ–∫ 2 (—á–µ—Ä–µ–∑, –≥–æ–¥):</strong></label>
                    <input type="number" name="step2_offset_hours" min="1" max="720" value="48"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 140px;">
                </div>
            </div>
            <div class="form-group">
                <textarea name="step2" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                          placeholder="–ü—ñ–¥–∫–∞–∂—ñ—Ç—å, –±—É–¥—å –ª–∞—Å–∫–∞, —á–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π –∑–∞—Ä–∞–∑ —Ä–µ–º–æ–Ω—Ç –≤–∞–Ω–Ω–æ—ó? –ú–æ–∂–µ–º–æ –ø–æ—Ä–∞–¥–∏—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è —ñ –∑–æ—Ä—ñ—î–Ω—Ç—É–≤–∞—Ç–∏ –ø–æ –±—é–¥–∂–µ—Ç—É –ø—ñ—Å–ª—è –∫—ñ–ª—å–∫–æ—Ö –¥–µ—Ç–∞–ª–µ–π."></textarea>
            </div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
                <div style="flex: 1; min-width: 240px;">
                    <label><strong>–ö—Ä–æ–∫ 3 (—á–µ—Ä–µ–∑, –≥–æ–¥):</strong></label>
                    <input type="number" name="step3_offset_hours" min="1" max="720" value="120"
                           style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 140px;">
                </div>
            </div>
            <div class="form-group">
                <textarea name="step3" rows="3" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                          placeholder="–Ø–∫—â–æ —Ö–æ—á–µ—Ç–µ, –∑—Ä–æ–±–∏–º–æ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω—É –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—é/—Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫. –ù–∞–ø–∏—à—ñ—Ç—å —Ä–∞–π–æ–Ω —ñ –ø—Ä–∏–±–ª–∏–∑–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏ –≤–∞–Ω–Ω–æ—ó –∫—ñ–º–Ω–∞—Ç–∏."></textarea>
            </div>

            <button type="submit" class="btn-primary"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; width: fit-content;">
                üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º—É
            </button>

            <div style="color:#666; font-size: 0.9em;">
                –í–æ—Ä–∫–µ—Ä: <code>py -3.10 invite_campaign_runner.py</code> (–ø–æ—Ç—Ä—ñ–±–Ω–æ <code>ENABLE_INVITE_CAMPAIGN=true</code> –≤ .env)
                <br>
                –û–¥–∏–Ω –∑–∞–ø—É—Å–∫ –≤—Å—ñ—Ö –≤–æ—Ä–∫–µ—Ä—ñ–≤: <code>py -3.10 all_workers_runner.py</code> (–ø–æ—Ç—Ä—ñ–±–Ω–æ <code>ENABLE_ALL_WORKERS=true</code>)
            </div>
        </form>
    </div>
    
    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
    <div class="alert alert-warning" style="background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h3>‚ö†Ô∏è –í–∞–∂–ª–∏–≤–æ! –õ—ñ–º—ñ—Ç–∏ Instagram:</h3>
        <ul>
            <li><strong>–ù–æ–≤—ñ –∞–∫–∞—É–Ω—Ç–∏:</strong> 10-20 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ –¥–µ–Ω—å</li>
            <li><strong>–°—Ç–∞—Ä—ñ –∞–∫–∞—É–Ω—Ç–∏ (6+ –º—ñ—Å—è—Ü—ñ–≤):</strong> 50-80 –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ –¥–µ–Ω—å</li>
            <li><strong>–ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏:</strong> –º—ñ–Ω—ñ–º—É–º 30-60 —Å–µ–∫—É–Ω–¥</li>
            <li><strong>–†–∏–∑–∏–∫–∏:</strong> —Ç–∏–º—á–∞—Å–æ–≤–∏–π –±–∞–Ω, –æ–±–º–µ–∂–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ–π, –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –∞–∫–∞—É–Ω—Ç–∞</li>
        </ul>
        <p>üí° –†–µ–∫–æ–º–µ–Ω–¥—É—î–º–æ: –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–µ –±—ñ–ª—å—à–µ 20 –Ω–∞ –¥–µ–Ω—å, –ø—Ä–∏—Ä–æ–¥–Ω—ñ –∑–∞—Ç—Ä–∏–º–∫–∏.</p>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
        <div class="stat-card" style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #2e7d32;">{{ total_followers }}</div>
            <div>–í—Å—å–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤</div>
        </div>
        <div class="stat-card" style="background: #e3f2fd; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #1565c0;">{{ target_audience }}</div>
            <div>–¶—ñ–ª—å–æ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è</div>
        </div>
        <div class="stat-card" style="background: #fff3e0; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #ef6c00;">{{ messages_sent_today }}</div>
            <div>–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ —Å—å–æ–≥–æ–¥–Ω—ñ</div>
        </div>
        <div class="stat-card" style="background: #fce4ec; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-size: 2em; font-weight: bold; color: #c2185b;">{{ daily_limit - messages_sent_today }}</div>
            <div>–ó–∞–ª–∏—à–∏–ª–æ—Å—å —Å—å–æ–≥–æ–¥–Ω—ñ</div>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º–∞ —Ä–æ–∑—Å–∏–ª–∫–∏ -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2>‚úçÔ∏è –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ä–æ–∑—Å–∏–ª–∫—É</h2>
        
        <form id="messagingForm" method="POST" action="{{ url_for('send_messages') }}">
            <!-- –í–∏–±—ñ—Ä –∞–∫–∞—É–Ω—Ç–∞ -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>üì± –ê–∫–∞—É–Ω—Ç –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏:</strong></label>
                <select name="account_id" class="form-control" style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;" required>
                    <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç --</option>
                    {% for account in accounts %}
                    <option value="{{ account.id }}">@{{ account.instagram_username }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- –í–∏–±—ñ—Ä –∞—É–¥–∏—Ç–æ—Ä—ñ—ó -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>üë• –ö–æ–º—É –≤—ñ–¥–ø—Ä–∞–≤–ª—è—Ç–∏:</strong></label>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="audience" value="target" checked> 
                        üéØ –¢—ñ–ª—å–∫–∏ —Ü—ñ–ª—å–æ–≤–∞ –∞—É–¥–∏—Ç–æ—Ä—ñ—è ({{ target_audience }})
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="audience" value="frankfurt"> 
                        üìç –†–µ–≥—ñ–æ–Ω –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç ({{ frankfurt_region }})
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px;">
                        <input type="radio" name="audience" value="all"> 
                        üìã –í—Å—ñ –∫–æ–Ω—Ç–∞–∫—Ç–∏ ({{ total_followers }})
                    </label>
                </div>
            </div>
            
            <!-- –õ–∏–º–∏—Ç -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>üî¢ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–º–∞–∫—Å. {{ daily_limit - messages_sent_today }}):</strong></label>
                <input type="number" name="limit" class="form-control" 
                       style="width: 150px; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                       min="1" max="{{ daily_limit - messages_sent_today }}" value="10" required>
            </div>
            
            <!-- –ó–∞—Ç—Ä–∏–º–∫–∞ -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>‚è±Ô∏è –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ (—Å–µ–∫—É–Ω–¥):</strong></label>
                <input type="number" name="delay" class="form-control" 
                       style="width: 150px; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                       min="30" max="300" value="45" required>
                <small style="color: #666;">–ú—ñ–Ω—ñ–º—É–º 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–µ–∑–ø–µ–∫–∏</small>
            </div>
            
            <!-- –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>üí¨ –¢–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:</strong></label>
                <textarea name="message" class="form-control" rows="5" 
                          style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ddd;"
                          placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...

–ú–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ:
{name} - —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
{username} - @username" required></textarea>
                <small style="color: #666;">
                    –ü—Ä–∏–∫–ª–∞–¥: "–ü—Ä–∏–≤—ñ—Ç, {name}! –ú–∏ –∑–∞–π–º–∞—î–º–æ—Å—å —É–∫–ª–∞–¥–∞–Ω–Ω—è–º –ø–ª–∏—Ç–∫–∏ —É –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç—ñ. –¶—ñ–∫–∞–≤–∏—Ç—å –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è?"
                </small>
            </div>
            
            <!-- –®–∞–±–ª–æ–Ω—ã -->
            <div class="form-group" style="margin-bottom: 20px;">
                <label><strong>üìù –ì–æ—Ç–æ–≤—ñ —à–∞–±–ª–æ–Ω–∏:</strong></label>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button type="button" class="template-btn" onclick="useTemplate('intro')"
                            style="padding: 8px 15px; background: #e3f2fd; border: none; border-radius: 6px; cursor: pointer;">
                        üëã –ó–Ω–∞–π–æ–º—Å—Ç–≤–æ
                    </button>
                    <button type="button" class="template-btn" onclick="useTemplate('offer')"
                            style="padding: 8px 15px; background: #e8f5e9; border: none; border-radius: 6px; cursor: pointer;">
                        üíº –ü—Ä–æ–ø–æ–∑–∏—Ü—ñ—è
                    </button>
                    <button type="button" class="template-btn" onclick="useTemplate('discount')"
                            style="padding: 8px 15px; background: #fff3e0; border: none; border-radius: 6px; cursor: pointer;">
                        üéÅ –ó–Ω–∏–∂–∫–∞
                    </button>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
            <div style="display: flex; gap: 15px; align-items: center;">
                <button type="submit" class="btn-primary" 
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer;">
                    üöÄ –ü–æ—á–∞—Ç–∏ —Ä–æ–∑—Å–∏–ª–∫—É
                </button>
                <label style="display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" name="confirm" required>
                    –Ø —Ä–æ–∑—É–º—ñ—é —Ä–∏–∑–∏–∫–∏ —Ç–∞ –ø–æ–≥–æ–¥–∂—É—é—Å—å
                </label>
            </div>
        </form>
    </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫ -->
    <div class="card" style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-top: 20px;">
        <h2>üìä –Ü—Å—Ç–æ—Ä—ñ—è —Ä–æ–∑—Å–∏–ª–æ–∫</h2>
        {% if message_logs %}
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f5f5f5;">
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">–î–∞—Ç–∞</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">–ê–∫–∞—É–Ω—Ç</th>
                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">–í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ</th>
                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">–£—Å–ø—ñ—à–Ω–æ</th>
                    <th style="padding: 12px; text-align: center; border-bottom: 2px solid #ddd;">–ü–æ–º–∏–ª–∫–∏</th>
                    <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for log in message_logs %}
                <tr>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">{{ log.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">@{{ log.account_username }}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee;">{{ log.total_sent }}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: green;">{{ log.successful }}</td>
                    <td style="padding: 12px; text-align: center; border-bottom: 1px solid #eee; color: red;">{{ log.failed }}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        {% if log.status == 'completed' %}
                        <span style="color: green;">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        {% elif log.status == 'running' %}
                        <span style="color: orange;">üîÑ –í –ø—Ä–æ—Ü–µ—Å—ñ</span>
                        {% else %}
                        <span style="color: red;">‚ùå {{ log.status }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="color: #666; text-align: center; padding: 40px;">–ü–æ–∫–∏ –Ω–µ–º–∞—î —Ä–æ–∑—Å–∏–ª–æ–∫</p>
        {% endif %}
    </div>
</div>

<script>
// Settings JSON from server for prefill
window.dmSettings = {{ (dm_settings_json or {}) | tojson }};
window.inviteCampaignSettings = {{ (invite_settings_json or {}) | tojson }};

const templates = {
    intro: `–ü—Ä–∏–≤—ñ—Ç, {name}! üëã

–ü–æ–±–∞—á–∏–≤ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å —ñ –≤–∏—Ä—ñ—à–∏–≤ –Ω–∞–ø–∏—Å–∞—Ç–∏. –ú–∏ –∑–∞–π–º–∞—î–º–æ—Å—å –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–º —É–∫–ª–∞–¥–∞–Ω–Ω—è–º –ø–ª–∏—Ç–∫–∏ —Ç–∞ —Ä–µ–º–æ–Ω—Ç–æ–º –≤–∞–Ω–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç —É —Ä–µ–≥—ñ–æ–Ω—ñ –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç.

–Ø–∫—â–æ –≤–∞—Å —Ü—ñ–∫–∞–≤–∏—Ç—å —è–∫—ñ—Å–Ω–∏–π —Ä–µ–º–æ–Ω—Ç - –±—É–¥—É —Ä–∞–¥–∏–π –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è! üè†`,
    
    offer: `–í—ñ—Ç–∞—é, {name}! 

–ù–∞—à–∞ –∫–æ–º–ø–∞–Ω—ñ—è —Å–ø–µ—Ü—ñ–∞–ª—ñ–∑—É—î—Ç—å—Å—è –Ω–∞:
üîπ –£–∫–ª–∞–¥–∞–Ω–Ω—è –ø–ª–∏—Ç–∫–∏
üîπ –†–µ–º–æ–Ω—Ç –≤–∞–Ω–Ω–∏—Ö –∫—ñ–º–Ω–∞—Ç
üîπ –°–∞–Ω—Ç–µ—Ö–Ω—ñ—á–Ω—ñ —Ä–æ–±–æ—Ç–∏

–ü—Ä–∞—Ü—é—î–º–æ –ø–æ –≤—Å—å–æ–º—É –§—Ä–∞–Ω–∫—Ñ—É—Ä—Ç—É —Ç–∞ –æ–∫–æ–ª–∏—Ü—è—Ö. –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π –≤–∏—ó–∑–¥ –Ω–∞ –∑–∞–º—ñ—Ä!

–ó–∞—Ü—ñ–∫–∞–≤–∏–ª–æ? –ù–∞–ø–∏—à—ñ—Ç—å - –æ–±–≥–æ–≤–æ—Ä–∏–º–æ –¥–µ—Ç–∞–ª—ñ üí¨`,
    
    discount: `–ü—Ä–∏–≤—ñ—Ç, {name}! üéÅ

–ú–∞—î–º–æ —Å–ø–µ—Ü—ñ–∞–ª—å–Ω—É –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—é –¥–ª—è –Ω–æ–≤–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤:
‚≠ê -15% –Ω–∞ —É–∫–ª–∞–¥–∞–Ω–Ω—è –ø–ª–∏—Ç–∫–∏
‚≠ê –ë–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—è
‚≠ê –ì–∞—Ä–∞–Ω—Ç—ñ—è 2 —Ä–æ–∫–∏

–ê–∫—Ü—ñ—è –¥—ñ—î –¥–æ –∫—ñ–Ω—Ü—è –º—ñ—Å—è—Ü—è. –í—Å—Ç–∏–≥–Ω—ñ—Ç—å —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—å! 

–ù–∞–ø–∏—à—ñ—Ç—å "–•–æ—á—É –∑–Ω–∏–∂–∫—É" –¥–ª—è –¥–µ—Ç–∞–ª–µ–π üëá`
};

function useTemplate(name) {
    document.querySelector('textarea[name="message"]').value = templates[name];
}

function _setSelectValue(selectEl, value) {
    if (!selectEl) return;
    const v = value == null ? '' : String(value);
    for (const opt of selectEl.options) {
        if (opt.value === v) {
            selectEl.value = v;
            return;
        }
    }
}

(function initDmAssistantPrefill() {
    const form = document.getElementById('dmAssistantForm');
    if (!form) return;
    const select = form.querySelector('select[name="account_id"]');
    if (!select) return;

    const enabled = form.querySelector('input[name="enabled"]');
    const replyToExisting = form.querySelector('input[name="reply_to_existing_threads"]');
    const language = form.querySelector('select[name="language"]');
    const maxPerDay = form.querySelector('input[name="max_replies_per_day"]');
    const instructions = form.querySelector('textarea[name="system_instructions"]');

    function apply() {
        const s = (window.dmSettings || {})[select.value];
        if (!s) return;
        if (enabled) enabled.checked = !!s.enabled;
        if (replyToExisting) replyToExisting.checked = !!s.reply_to_existing_threads;
        if (language) _setSelectValue(language, s.language || 'ru');
        if (maxPerDay && s.max_replies_per_day != null) maxPerDay.value = s.max_replies_per_day;
        if (instructions && s.system_instructions != null) instructions.value = s.system_instructions;
    }

    select.addEventListener('change', apply);
})();

(function initInviteCampaignPrefill() {
    const form = document.getElementById('inviteCampaignForm');
    if (!form) return;
    const select = form.querySelector('select[name="account_id"]');
    if (!select) return;

    const enabled = form.querySelector('input[name="enabled"]');
    const audience = form.querySelector('select[name="audience_type"]');
    const maxPerDay = form.querySelector('input[name="max_sends_per_day"]');
    const minDelay = form.querySelector('input[name="min_delay_seconds"]');
    const maxDelay = form.querySelector('input[name="max_delay_seconds"]');
    const stopOnReply = form.querySelector('input[name="stop_on_inbound_reply"]');

    const step1 = form.querySelector('textarea[name="step1"]');
    const step2 = form.querySelector('textarea[name="step2"]');
    const step3 = form.querySelector('textarea[name="step3"]');
    const step2Offset = form.querySelector('input[name="step2_offset_hours"]');
    const step3Offset = form.querySelector('input[name="step3_offset_hours"]');

    function apply() {
        const s = (window.inviteCampaignSettings || {})[select.value];
        if (!s) return;

        if (enabled) enabled.checked = !!s.enabled;
        if (audience) _setSelectValue(audience, s.audience_type || 'target');
        if (maxPerDay && s.max_sends_per_day != null) maxPerDay.value = s.max_sends_per_day;
        if (minDelay && s.min_delay_seconds != null) minDelay.value = s.min_delay_seconds;
        if (maxDelay && s.max_delay_seconds != null) maxDelay.value = s.max_delay_seconds;
        if (stopOnReply) stopOnReply.checked = (s.stop_on_inbound_reply !== false);

        const steps = Array.isArray(s.steps) ? s.steps : [];
        if (step1) step1.value = (steps[0] && steps[0].template) ? steps[0].template : '';
        if (step2) step2.value = (steps[1] && steps[1].template) ? steps[1].template : '';
        if (step3) step3.value = (steps[2] && steps[2].template) ? steps[2].template : '';
        if (step2Offset) step2Offset.value = (steps[1] && steps[1].offset_hours != null) ? steps[1].offset_hours : (step2Offset.value || 48);
        if (step3Offset) step3Offset.value = (steps[2] && steps[2].offset_hours != null) ? steps[2].offset_hours : (step3Offset.value || 120);
    }

    select.addEventListener('change', apply);
})();
</script>

<style>
.template-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.btn-primary:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
}
</style>
{% endblock %}
